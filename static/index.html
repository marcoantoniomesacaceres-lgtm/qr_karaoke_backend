
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Karaoke 'LA CANTA QUE RANA'</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #121212;
            color: #e0e0e0;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .login-view { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
        .login-box {
            background-color: #1e1e1e;
            padding: 2em;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 100%;
        }
        h1, h2 { color: #4CAF50; }
        p { color: #b0b0b0; }
        input {
            width: calc(100% - 24px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #444;
            background-color: #333;
            color: #fff;
            font-size: 1em;
        }
        button {
            padding: 12px;
            background-color: #4CAF50;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) { background-color: #45a049; }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        .error-msg { color: #ff4d4d; margin-top: 1em; min-height: 1.2em; }
        .hidden {
            display: none;
        }
        .tabs { display: flex; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .tab-button { background: none; border: none; color: #aaa; padding: 15px 20px; cursor: pointer; font-size: 1em; }
        .tab-button.active { color: #4CAF50; border-bottom: 2px solid #4CAF50; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .song-list { list-style: none; padding: 0; }
        .song-item { background-color: #1e1e1e; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .song-item-info { display: flex; align-items: center; gap: 15px; }
        .song-item img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; }
        .song-title { font-weight: bold; }
        .song-status { font-size: 0.8em; padding: 4px 8px; border-radius: 12px; color: #121212; }
        .status-pendiente { background-color: #ffc107; }
        .status-aprobado { background-color: #28a745; }
        .status-reproduciendo { background-color: #17a2b8; animation: pulse 1.5s infinite; }
        .status-cantada { background-color: #6c757d; }
        .status-rechazada { background-color: #dc3545; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(23, 162, 184, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(23, 162, 184, 0); } 100% { box-shadow: 0 0 0 0 rgba(23, 162, 184, 0); } }
        .profile-card { background-color: #1e1e1e; padding: 20px; border-radius: 8px; text-align: center; }
        .profile-card h3 { margin-top: 0; }
        .profile-level { font-size: 1.2em; font-weight: bold; }
        .level-bronce { color: #cd7f32; }
        .level-plata { color: #c0c0c0; }
        .level-oro { color: #ffd700; }
        #search-results { max-height: 400px; overflow-y: auto; }
        #notification-banner {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: top 0.5s ease-in-out;
            z-index: 1000;
        }
        /* Estilos para el Cat√°logo de Productos */
        .product-catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .product-card {
            background-color: #1e1e1e;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        .product-card img { width: 100%; height: 150px; object-fit: cover; background-color: #333; }
        .product-card-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .product-card-title { font-size: 1.1em; font-weight: bold; margin: 0 0 5px 0; }
        .product-card-category { font-size: 0.8em; color: #aaa; margin-bottom: 10px; }
        .product-card-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; }
        .product-price { font-size: 1.2em; font-weight: bold; color: #bb86fc; }
        .product-card .order-btn { background-color: #bb86fc; font-size: 0.9em; padding: 8px 16px; }

        /* Estilos para el Modal de Confirmaci√≥n */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: #1e1e1e; padding: 30px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        .modal-content h3 { margin-top: 0; color: #bb86fc; }
        .modal-content label { display: block; margin: 15px 0 5px 0; }
        .modal-content input[type="number"] { text-align: center; width: 80px; }
        .modal-actions { margin-top: 20px; display: flex; justify-content: space-around; }
        .modal-actions button { width: 120px; }
        .btn-confirm { background-color: #4CAF50; }
        .btn-cancel { background-color: #6c757d; }
        #notification.error {
        .order-item .cancel-btn {
            background-color: #cf6679; /* Rojo suave */
        }
        .order-item .cancel-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            background-color: #cf6679;
            color: #121212;
        }
        #notification.success {
            background-color: #66bb6a;
            color: #121212;
        }
        /* Estilos para el boton confirmar pedido */
        #cart-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #bb86fc;
            color: #121212;
            border-radius: 50%;
            border-radius: 8px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 1500;
            transition: transform 0.2s;
        }
        #cart-fab:hover { transform: scale(1.1); }
        #cart-count { position: absolute; top: 0; right: 0; background: #f44336; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 14px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .modal-content .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #333; }
        .modal-content .cart-item-name { flex-grow: 1; }

        /* Estilos para las reacciones con emoticonos */
        .reaction-container {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Para que no interfiera con los clics */
            overflow: hidden;
            z-index: 9999;
        }
        .reaction-emoji {
            position: absolute;
            bottom: -50px; /* Empieza fuera de la pantalla */
            font-size: 3rem;
            animation: float-up 5s ease-out forwards;
        }
        @keyframes float-up {
            to { bottom: 100%; transform: translateX(var(--tx, 0)) scale(1.5); opacity: 0; }
        }

        /* Estilos para la secci√≥n "Mis Cuentas" */
        .account-view { background-color: #1e1e1e; padding: 20px; border-radius: 8px; }
        .account-summary { font-size: 1.1em; line-height: 1.6; }
        .account-summary strong { font-size: 1.2em; }
        .saldo-pendiente { font-size: 1.3em !important; font-weight: bold; }
        .saldo-ok { color: #66bb6a; }
        .saldo-debe { color: #cf6679; }
        .details-section {
            margin-top: 15px;
            background-color: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            max-height: 250px;
            overflow-y: auto;
        }
        .details-section h4 { margin-top: 0; color: #bb86fc; }
        .details-section .item-list li {
            padding: 8px 4px;
            border-bottom: 1px dotted #444;
            font-size: 0.95em;
        }
    </style>
    <style>
        /* Estilos para las reacciones con emoticonos */
        .reaction-container {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Para que no interfiera con los clics */
            overflow: hidden;
            z-index: 9999;
        }
        .reaction-emoji {
            position: absolute;
            bottom: -50px; /* Empieza fuera de la pantalla */
            font-size: 3rem;
            animation: float-up 5s ease-out forwards;
        }
        @keyframes float-up {
            to { bottom: 100%; transform: translateX(var(--tx, 0)) scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="notification-banner"></div>

    <div class="login-view" id="login-container">
        <div class="login-box">
            <h1>¬°Bienvenido a LA CANTA QUE RANA!</h1>
            <p id="welcome-message">Para empezar, elige un apodo para esta noche.</p>
            <form id="login-form">
                <input type="text" id="nick-input" placeholder="Tu apodo" required autocomplete="off">
                <button type="button" id="connect-button">Conectar</button>
            </form>
            <div class="error-msg" id="error-message"></div>
        </div>
    </div>

    <div class="container hidden" id="dashboard-view">
        <h1 style="text-align: center; margin-bottom: 20px;">LA CANTA QUE RANA</h1>
        <div class="profile-card">
            <h3><span id="user-nick"></span></h3>
            <p>Mesa: <strong id="table-name"></strong></p>
            <p>Puntos: <strong id="user-points">0</strong></p>
            <p>Nivel: <strong id="user-level" class="profile-level"></strong></p>
            <button id="logout-button" style="width: auto; font-size: 0.8em; padding: 8px 12px;">Salir</button>
            <!-- NUEVA SECCI√ìN DE REACCIONES -->
            <div style="margin-top: 20px;">
                <h4>Enviar Reacci√≥n</h4>
                <div id="reaction-buttons" style="display: flex; justify-content: center; gap: 15px; font-size: 1.5em; cursor: pointer;">
                    <span title="¬°Genial!">üòä</span>
                    <span title="¬°Me gusta!">üëç</span>
                    <span title="¬°Fuego!">üî•</span>
                    <span title="¬°Incre√≠ble!">ü§©</span>
                    <span title="¬°Buena voz!">üé§</span>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" data-tab="tab-queue">Cola</button>
            <button class="tab-button" data-tab="tab-search">Buscar Canci√≥n</button>
            <button class="tab-button" data-tab="tab-catalog">Cat√°logo</button>
            <button class="tab-button" data-tab="tab-my-orders">Mis Pedidos</button>
            <button class="tab-button" data-tab="tab-my-account">Mi Consumo</button>
            <button class="tab-button" data-tab="tab-my-list">Mi Lista</button>
        </div>

        <!-- Pesta√±a de la Cola de Karaoke -->
        <div id="tab-queue" class="tab-content active">
            <h2>Ahora Sonando</h2>
            <div id="now-playing-container">
                <p>La cola est√° vac√≠a. ¬°A√±ade una canci√≥n!</p>
            </div>
            <h2>Pr√≥ximas Canciones</h2>
            <ul id="upcoming-list" class="song-list">
                <!-- Las canciones se insertar√°n aqu√≠ din√°micamente -->
            </ul>
        </div>

        <!-- Pesta√±a de B√∫squeda -->
        <div id="tab-search" class="tab-content">
            <h2>Buscar Canci√≥n en YouTube</h2>
            <form id="search-form">
                <input type="text" id="search-input" placeholder="Artista, canci√≥n o URL de YouTube" required>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button type="button" id="search-songs-btn" class="form-btn" style="background-color: #4CAF50; flex: 1;">Canciones</button>
                    <button type="button" id="search-karaoke-btn" class="form-btn" style="background-color: #bb86fc; flex: 1;">Karaoke</button>
                </div>
            </form>
            <div id="search-results" class="song-list">
                <!-- Los resultados de b√∫squeda se insertar√°n aqu√≠ -->
            </div>
        </div>

        <!-- Pesta√±a de Cat√°logo de Productos -->
        <div id="tab-catalog" class="tab-content">
            <div class="catalog-header">
                <h2>Cat√°logo de Productos</h2>
                <button id="cart-confirm-btn-header">Confirmar Pedido (<span id="cart-count">0</span>)</button>
            </div>
            <div id="product-catalog-list" class="product-catalog-grid">
                <!-- Los productos se insertar√°n aqu√≠ -->
            </ul>
        </div>

        <!-- Pesta√±a de Mis Pedidos -->
        <div id="tab-my-orders" class="tab-content">
            <h2>Mis Pedidos Recientes</h2>
            <ul id="my-orders-list" class="song-list">
                <!-- Los pedidos del usuario se insertar√°n aqu√≠ -->
            </ul>
        </div>

        <!-- Pesta√±a de Mis Cuentas -->
        <div id="tab-my-account" class="tab-content">
            <h2>Mi Consumo en la Mesa</h2>
            <div id="my-account-content">Cargando estado de cuenta...</div>
        </div>

        <!-- Pesta√±a de Mi Lista -->
        <div id="tab-my-list" class="tab-content">
            <h2>Mis Canciones</h2>
            <ul id="my-song-list" class="song-list">
                <!-- Las canciones del usuario se insertar√°n aqu√≠ -->
            </ul>
        </div>
    </div>

    <!-- Modal para confirmar pedido -->
    <div id="order-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-product-name"></h3>
            <p>¬øCu√°ntas unidades deseas pedir?</p>
            <label for="quantity-input">Cantidad</label>
            <input type="number" id="quantity-input" value="1" min="1" max="10">
            <div class="modal-actions">
                <button id="confirm-order-btn" class="btn-confirm">Confirmar Pedido</button>
                <button id="cancel-order-btn" class="btn-cancel">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para el Carrito de Compras -->
    <div id="cart-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>üõí Mi Pedido</h3>
            <div id="cart-items-list" style="text-align: left; margin-bottom: 20px;">
                <p>Tu carrito est√° vac√≠o.</p>
            </div>
            <div class="modal-actions">
                <button id="confirm-cart-order-btn" class="btn-confirm" style="background-color: #2196F3;">Hacer Pedido</button>
                <button id="cancel-cart-btn" class="btn-cancel">Seguir Comprando</button>
            </div>
        </div>
    </div>

    <!-- Contenedor para mostrar las reacciones flotantes -->
    <div id="reaction-container" class="reaction-container"></div>

    <script>
        // --- CONFIGURACI√ìN ---
        const API_BASE_URL = '/api/v1';
        const WEBSOCKET_URL = `ws://${window.location.host}/ws/cola`;

        // --- ESTADO DE LA APLICACI√ìN ---
        let state = {
            user: null,
            tableQrCode: null,
            websocket: null,
            cart: [], // ¬°NUEVO ESTADO PARA EL CARRITO!
        };

        // --- ELEMENTOS DEL DOM ---
        const loginContainer = document.getElementById('login-container');
        const dashboardView = document.getElementById('dashboard-view');
        const loginForm = document.getElementById('login-form');
        const nickInput = document.getElementById('nick-input');
        const connectButton = document.getElementById('connect-button');
        const errorMessage = document.getElementById('error-message');
        const welcomeMessage = document.getElementById('welcome-message');
        const logoutButton = document.getElementById('logout-button');
        const notificationBanner = document.getElementById('notification-banner');
        const orderModal = document.getElementById('order-modal');
        const modalProductName = document.getElementById('modal-product-name');
        const quantityInput = document.getElementById('quantity-input');
        const cartModal = document.getElementById('cart-modal');
        const cartConfirmBtnHeader = document.getElementById('cart-confirm-btn-header');
        const confirmOrderBtn = document.getElementById('confirm-order-btn');
        const cancelOrderBtn = document.getElementById('cancel-order-btn');
        const catalogList = document.getElementById('product-catalog-list');


        // --- FUNCIONES DE RENDERIZADO ---

        function renderQueue(queueData) {
            const nowPlayingContainer = document.getElementById('now-playing-container');
            const upcomingList = document.getElementById('upcoming-list');
            nowPlayingContainer.innerHTML = '';
            upcomingList.innerHTML = '';

            if (queueData.now_playing) {
                nowPlayingContainer.innerHTML = createSongItemHTML(queueData.now_playing, false);
            } else {
                nowPlayingContainer.innerHTML = '<p>La cola est√° vac√≠a. ¬°A√±ade una canci√≥n!</p>';
            }

            if (queueData.upcoming && queueData.upcoming.length > 0) {
                queueData.upcoming.forEach(song => {
                    upcomingList.innerHTML += createSongItemHTML(song, false);
                });
            } else if (!queueData.now_playing) {
                 upcomingList.innerHTML = '';
            } else {
                 upcomingList.innerHTML = '<li><p>No hay m√°s canciones en la cola.</p></li>';
            }
        }

        function renderMyList(songs) {
            const myList = document.getElementById('my-song-list');
            myList.innerHTML = '';
            if (songs.length > 0) {
                songs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).forEach(song => {
                    myList.innerHTML += createSongItemHTML(song, true);
                });
            } else {
                myList.innerHTML = '<li><p>A√∫n no has a√±adido ninguna canci√≥n.</p></li>';
            }
        }

        function createSongItemHTML(song, isMyList) {
            const statusClass = `status-${song.estado}`;
            const canDelete = isMyList && song.estado === 'pendiente';
            const scoreInfo = isMyList && song.estado === 'cantada' && song.puntuacion_ia ? `<div class="song-score">Puntaje: <strong>${song.puntuacion_ia}</strong></div>` : '';
            const deleteButton = `<button class="delete-song-btn" data-song-id="${song.id}" style="background-color: #dc3545;">Eliminar</button>`;

            return `
                <li class="song-item" id="song-${song.id}">
                    <div class="song-item-info">
                        <img src="https://i.ytimg.com/vi/${song.youtube_id}/mqdefault.jpg" alt="Miniatura">
                        <div>
                            <div class="song-title">${song.titulo}</div>
                            ${song.usuario ? `<div class="song-user">por: ${song.usuario.nick}</div>` : ''}
                        </div>
                    </div>
                    <div>
                        ${scoreInfo}
                        ${isMyList ? `<span class="song-status ${statusClass}">${song.estado}</span>` : ''}
                        ${canDelete ? deleteButton : ''}
                    </div>
                </li>
            `;
        }

        function renderCatalog(products) {
            catalogList.innerHTML = '';
            const availableProducts = products.filter(p => p.is_active && p.stock > 0);

            if (availableProducts.length > 0) {
                availableProducts.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    const imageUrl = product.imagen_url || `https://via.placeholder.com/300x200.png?text=${encodeURIComponent(product.nombre)}`;
                    productCard.innerHTML = `
                        <img src="${imageUrl}" alt="${product.nombre}" onerror="this.onerror=null;this.src='https://via.placeholder.com/300x200.png?text=Imagen+no+disponible';">
                        <div class="product-card-body">
                            <h3 class="product-card-title">${product.nombre}</h3>
                            <p class="product-card-category">${product.categoria}</p>
                            <div class="product-card-footer">
                                <span class="product-price">$${product.valor}</span>
                                <button class="add-to-cart-btn" data-product-id="${product.id}" data-product-name="${product.nombre}" data-product-stock="${product.stock}">A√±adir</button>
                            </div>
                        </div>
                    `;
                    catalogList.appendChild(productCard);
                });
            } else {
                catalogList.innerHTML = '<p>No hay productos disponibles en este momento.</p>';
            }
        }

        function renderCart() {
            const cartItemsList = document.getElementById('cart-items-list');
            const cartCount = document.getElementById('cart-count');
            const confirmCartBtn = document.getElementById('confirm-cart-order-btn');
            const cartHeaderBtn = document.getElementById('cart-confirm-btn-header');

            const totalItems = state.cart.reduce((sum, item) => sum + item.cantidad, 0);
            cartCount.textContent = totalItems;
            cartCount.style.display = totalItems > 0 ? 'flex' : 'none';

            if (state.cart.length === 0) {
                cartItemsList.innerHTML = '<p>Tu carrito est√° vac√≠o.</p>';
                confirmCartBtn.disabled = true;
                cartHeaderBtn.style.display = 'none'; // Ocultar el bot√≥n si el carrito est√° vac√≠o
            } else {
                cartItemsList.innerHTML = '';
                state.cart.forEach(item => {
                    cartItemsList.innerHTML += `
                        <div class="cart-item">
                            <span class="cart-item-name">${item.cantidad}x ${item.nombre}</span>
                            <button class="cart-remove-item-btn" data-product-id="${item.producto_id}" style="font-size: 0.8em; padding: 4px 8px; background-color: #dc3545;">X</button>
                        </div>
                    `;
                });
                confirmCartBtn.disabled = false;
                cartHeaderBtn.style.display = 'inline-block'; // Mostrar el bot√≥n si hay items
            }
        }

        function addToCart(productId, productName, stock) {
            const existingItem = state.cart.find(item => item.producto_id === productId);
            if (existingItem) {
                if (existingItem.cantidad < stock) existingItem.cantidad++;
            } else {
                state.cart.push({ producto_id: productId, nombre: productName, cantidad: 1 });
            }
            renderCart();
        }

        function renderMyOrders(consumos) {
            const myOrdersList = document.getElementById('my-orders-list');
            myOrdersList.innerHTML = '';
            if (consumos.length > 0) {
                consumos.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).forEach(consumo => {
                    const timeSinceOrder = (new Date() - new Date(consumo.created_at)) / 1000; // en segundos
                    const canCancel = timeSinceOrder < 60;
                    const cancelButton = `
                        <button class="cancel-btn" data-consumo-id="${consumo.id}" ${!canCancel ? 'disabled' : ''}>
                            ${canCancel ? 'Cancelar' : 'Expirado'}
                        </button>`;

                    myOrdersList.innerHTML += `
                        <li class="song-item order-item" id="consumo-${consumo.id}">
                            <div class="song-item-info">
                                <img src="${consumo.producto.imagen_url || 'https://via.placeholder.com/80x60.png?text=Producto'}" alt="${consumo.producto.nombre}">
                                <div>
                                    <div class="song-title">${consumo.cantidad}x ${consumo.producto.nombre}</div>
                                    <div class="song-user">Total: $${consumo.valor_total}</div>
                                </div>
                            </div>
                            <div>
                                ${cancelButton}
                            </div>
                        </li>
                    `;
                });
            } else {
                myOrdersList.innerHTML = '<li><p>A√∫n no has realizado ning√∫n pedido.</p></li>';
            }
        }

        function showNotification(message, type = 'success', duration = 3000) {
            notificationBanner.textContent = message;
            // Remove previous classes
            notificationBanner.classList.remove('success', 'error');
            // Add new class
            notificationBanner.classList.add(type);

            notificationBanner.style.top = '20px';

            setTimeout(() => {
                notificationBanner.style.top = '-100px';
            }, duration);
        }

        // --- L√ìGICA DE WEBSOCKET ---

        function connectWebSocket() {
            state.websocket = new WebSocket(WEBSOCKET_URL);

            state.websocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                // CORRECCI√ìN: Verificamos si el mensaje tiene un campo 'type' para manejar
                // notificaciones y otros eventos estructurados.
                if (data.type) {
                  if (data.type === 'notification' || data.type === 'admin_notification') {
                    showNotification(data.payload.mensaje);
                  } else if (data.type === 'product_update') {
                      fetchProducts(); // Recargamos el cat√°logo de productos
                  } else if (data.type === 'song_finished') {
                      fetchMyList(); // Recargamos la lista para ver el puntaje
                  } else if (data.type === 'consumo_deleted' || data.type === 'consumo_created') {
                      // Si se crea o elimina un consumo, actualizamos la lista de pedidos y el perfil
                      fetchMyOrders();
                      fetchTableAccountStatus(); // Actualizar tambi√©n la cuenta de la mesa
                  }
                  else if (data.type === 'reaction') {
                      const reactionPayload = data.payload;
                      if (reactionPayload && reactionPayload.reaction) {
                          const emoji = document.createElement('div');
                          emoji.className = 'reaction-emoji';
                          emoji.textContent = reactionPayload.reaction;
                          
                          // Posici√≥n horizontal aleatoria y animaci√≥n
                          emoji.style.left = `${Math.random() * 90 + 5}%`;
                          emoji.style.setProperty('--tx', `${(Math.random() - 0.5) * 100}px`);
                          
                          document.getElementById('reaction-container').appendChild(emoji);
                          setTimeout(() => emoji.remove(), 5000); // Limpiar despu√©s de la animaci√≥n
                      }
                  }
                } else {
                    // Si no tiene 'type', asumimos que es la actualizaci√≥n de la cola.
                    renderQueue(data);
                }
            };

            state.websocket.onclose = () => {
                console.log('WebSocket desconectado. Intentando reconectar en 5 segundos...');
                setTimeout(connectWebSocket, 5000);
            };

            state.websocket.onerror = (error) => {
                console.error('Error de WebSocket:', error);
                state.websocket.close();
            };
        }

        // --- L√ìGICA DE API Y EVENTOS ---

        async function handleLogin(event) {
            event.preventDefault();
            const nick = nickInput.value.trim();

            if (!nick) {
                errorMessage.textContent = 'Por favor, introduce un apodo.';
                return;
            }
            connectButton.disabled = true;
            connectButton.textContent = 'Conectando...';
            errorMessage.textContent = '';

            try {
                const response = await fetch(`${API_BASE_URL}/mesas/${encodeURIComponent(state.tableQrCode)}/conectar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nick: nick }),
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || 'Ocurri√≥ un error al conectar.');
                }
                state.user = data;
                sessionStorage.setItem('karaokeUser', JSON.stringify(state.user));
                sessionStorage.setItem('karaokeTable', state.tableQrCode);
                showDashboard();
            } catch (error) {
                errorMessage.textContent = error.message;
            } finally {
                connectButton.disabled = false;
                connectButton.textContent = 'Conectar';
            }
        }

        async function handleSearch(event, karaokeMode = false) {
            event.preventDefault();
            const query = document.getElementById('search-input').value.trim();
            if (!query) return;

            const songsButton = document.getElementById('search-songs-btn');
            const karaokeButton = document.getElementById('search-karaoke-btn');
            songsButton.disabled = true;
            karaokeButton.disabled = true;

            // Cambiar texto del bot√≥n presionado
            const clickedButton = karaokeMode ? karaokeButton : songsButton;
            const originalText = clickedButton.textContent;
            clickedButton.textContent = 'Buscando...';

            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '<p>Buscando...</p>';

            try {
                // Construimos la URL con el par√°metro karaoke_mode si es necesario
                const url = `${API_BASE_URL}/youtube/public-search?q=${encodeURIComponent(query)}${karaokeMode ? '&karaoke_mode=true' : ''}`;
                const response = await fetch(url);
                // Si la respuesta no es OK (ej: 403, 500), leemos el error y lo lanzamos
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Error del servidor: ${response.status}`);
                }

                const results = await response.json();
                resultsContainer.innerHTML = '';
                if (results.length > 0) {
                    results.forEach(song => {
                        resultsContainer.innerHTML += `
                            <li class="song-item">
                                <div class="song-item-info">
                                    <img src="${song.thumbnail}" alt="Miniatura">
                                    <div>
                                        <div class="song-title">${song.title}</div>
                                        <div class="song-duration">${Math.floor(song.duration_seconds / 60)}:${(song.duration_seconds % 60).toString().padStart(2, '0')}</div>
                                    </div>
                                </div>
                                <button class="add-song-btn" data-title="${song.title}" data-youtube-id="${song.video_id}" data-duration="${song.duration_seconds}">A√±adir</button>
                            </li>
                        `;
                    });
                } else {
                    resultsContainer.innerHTML = '<p>No se encontraron resultados.</p>';
                }
            } catch (error) {
                resultsContainer.innerHTML = `<p class="error-msg">Error al buscar: ${error.message}</p>`;
            } finally {
                songsButton.disabled = false;
                karaokeButton.disabled = false;
                clickedButton.textContent = originalText;
            }
        }

        async function handleAddSong(event) {
            if (!event.target.classList.contains('add-song-btn')) return;

            const button = event.target;
            button.disabled = true;
            button.textContent = 'A√±adiendo...';

            const songData = {
                titulo: button.dataset.title,
                youtube_id: button.dataset.youtubeId,
                duracion_seconds: parseInt(button.dataset.duration, 10)
            };

            try {
                const response = await fetch(`${API_BASE_URL}/canciones/${state.user.id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(songData)
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || 'Error al a√±adir la canci√≥n.');
                }
                showNotification(`'${songData.titulo}' a√±adida a tu lista.`);
                fetchMyList(); // CORRECCI√ìN: Actualiza "Mi Lista" inmediatamente despu√©s de a√±adir.
            } catch (error) {
                showNotification(error.message, 5000);
            } finally {
                button.disabled = false;
                button.textContent = 'A√±adir';
            }
        }

        async function handleDeleteSong(event) {
            if (!event.target.classList.contains('delete-song-btn')) return;
            if (!confirm('¬øSeguro que quieres eliminar esta canci√≥n de tu lista?')) return;

            const button = event.target;
            const songId = button.dataset.songId;
            button.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/canciones/${songId}?usuario_id=${state.user.id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'No se pudo eliminar la canci√≥n.');
                }
                showNotification('Canci√≥n eliminada.');
                fetchMyList();
            } catch (error) {
                showNotification(error.message, 5000);
                button.disabled = false;
            }
        }

        async function handleAddToCart(event) {
            if (!event.target.classList.contains('add-to-cart-btn')) return;

            const button = event.target;
            const productId = button.dataset.productId;
            const productName = button.dataset.productName;
            const productStock = parseInt(button.dataset.productStock, 10);

            addToCart(productId, productName, productStock);
            showNotification(`${productName} a√±adido al carrito.`, 'success', 1500);
        }

        async function handlePlaceOrder() {
            if (state.cart.length === 0) return;

            const confirmBtn = document.getElementById('confirm-cart-order-btn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Enviando...';

            const cartPayload = { items: state.cart };

            try {
                const response = await fetch(`${API_BASE_URL}/consumos/pedir/carrito/${state.user.id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cartPayload)
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.detail || 'Error al procesar el pedido.');

                showNotification('¬°Pedido realizado con √©xito!', 'success');
                state.cart = []; // Limpiar carrito
                renderCart();
                cartModal.style.display = 'none';
                fetchUserProfile();
                fetchMyOrders();
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error', 5000);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Hacer Pedido';
            }
        }

        async function handleCancelOrder(event) {
            if (!event.target.classList.contains('cancel-btn')) return;
            if (!confirm('¬øSeguro que quieres cancelar este pedido?')) return;

            const button = event.target;
            const consumoId = button.dataset.consumoId;
            button.disabled = true;
            button.textContent = 'Cancelando...';

            try {
                const response = await fetch(`${API_BASE_URL}/consumos/${consumoId}/cancelar/${state.user.id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'No se pudo cancelar el pedido.');
                }
                showNotification('Pedido cancelado con √©xito.', 'success');
                fetchMyOrders(); // Actualiza la lista de pedidos
                fetchTableAccountStatus(); // Actualiza la cuenta de la mesa
                fetchUserProfile(); // Actualiza los puntos y nivel del usuario
            } catch (error) {
                showNotification(error.message, 'error', 5000);
            }
        }

        async function fetchProducts() {
            catalogList.innerHTML = '<p>Cargando cat√°logo...</p>';
            const response = await fetch(`${API_BASE_URL}/productos/`);
            const products = await response.json();
            renderCatalog(products);
        }

        async function fetchMyList() {
            try {
                const response = await fetch(`${API_BASE_URL}/canciones/${state.user.id}/lista`);
                const songs = await response.json();
                renderMyList(songs);
            } catch (error) {
                console.error('Error al obtener mi lista:', error);
            }
        }

        async function fetchMyOrders() {
            if (!state.user) return;
            try {
                const response = await fetch(`${API_BASE_URL}/consumos/mis-pedidos/${state.user.id}`);
                const consumos = await response.json();
                renderMyOrders(consumos);
            } catch (error) { console.error('Error al obtener mis pedidos:', error); }
        }

        async function fetchTableAccountStatus() {
            if (!state.user) return;

            const container = document.getElementById('my-account-content');
            container.innerHTML = '<p>Cargando estado de cuenta...</p>';

            try {
                const response = await fetch(`${API_BASE_URL}/admin/my-table-account?usuario_id=${state.user.id}`);
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'No se pudo cargar la cuenta.');
                }
                const data = await response.json();

                // FIX: Convertir a n√∫mero antes de comparar
                const saldoPendienteNum = parseFloat(data.saldo_pendiente);
                const totalConsumidoNum = parseFloat(data.total_consumido);
                const totalPagadoNum = parseFloat(data.total_pagado);
                const saldoClass = saldoPendienteNum > 0 ? 'saldo-debe' : 'saldo-ok';

                container.innerHTML = `
                    <div class="account-view">
                        <h3>${data.mesa_nombre}</h3>
                        <div class="account-summary">
                            <div>Total Consumido: <strong>$${totalConsumidoNum.toFixed(2)}</strong></div>
                            <div>Total Pagado: <strong style="color: #66bb6a;">$${totalPagadoNum.toFixed(2)}</strong></div>
                            <div class="saldo-pendiente ${saldoClass}">Saldo: <strong>$${saldoPendienteNum.toFixed(2)}</strong></div>
                        </div>

                        <details style="margin-top: 20px;">
                            <summary style="cursor:pointer; color: #bb86fc;">Ver Detalles de Consumos y Pagos</summary>
                            <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr; gap: 15px;">
                                <div class="details-section">
                                    <h4>Consumos</h4>
                                    <ul class="item-list">
                                        ${data.consumos.length > 0 ? data.consumos.map(c => `
                                            <li style="font-size:0.9em; padding: 4px 0;">${c.cantidad}x ${c.producto_nombre} - $${parseFloat(c.valor_total).toFixed(2)} <span style="color: var(--text-secondary); font-size: 0.9em;">(${new Date(c.created_at).toLocaleTimeString()})</span></li>
                                        `).join('') : '<li>No hay consumos registrados.</li>'}
                                    </ul>
                                </div>
                                <div class="details-section">
                                    <h4>Pagos</h4>
                                    <ul class="item-list">
                                        ${data.pagos.length > 0 ? data.pagos.map(p => `
                                            <li style="font-size:0.9em; padding: 4px 0;">$${parseFloat(p.monto).toFixed(2)} (${p.metodo_pago}) - <span style="color: var(--text-secondary); font-size: 0.9em;">${new Date(p.created_at).toLocaleTimeString()}</span></li>
                                        `).join('') : '<li>No hay pagos registrados.</li>'}
                                    </ul>
                                </div>
                            </div>
                        </details>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<p class="error-msg">${error.message}</p>`;
            }
        }

        async function fetchUserProfile() {
            try {
                const response = await fetch(`${API_BASE_URL}/usuarios/${state.user.id}/perfil`);
                // --- INICIO DE LA CORRECCI√ìN ---
                if (!response.ok) {
                    throw new Error(`Error ${response.status} al obtener el perfil.`);
                }
                // --- FIN DE LA CORRECCI√ìN ---
                const profile = await response.json();
                state.user = profile; // Actualizamos el estado local del usuario
                sessionStorage.setItem('karaokeUser', JSON.stringify(state.user));
                updateProfileCard();
                fetchMyList(); // **CORRECCI√ìN: Cargar la lista de canciones despu√©s de actualizar el perfil.**
            } catch (error) {
                console.error('Error al actualizar el perfil:', error);
            }
        }

        function updateProfileCard() {
            document.getElementById('user-nick').textContent = state.user.nick;
            document.getElementById('user-points').textContent = state.user.puntos;
            const levelEl = document.getElementById('user-level');
            levelEl.textContent = state.user.nivel.charAt(0).toUpperCase() + state.user.nivel.slice(1);
            levelEl.className = `profile-level level-${state.user.nivel}`;
        }

        function showDashboard() {
            document.getElementById('table-name').textContent = state.tableQrCode;
            updateProfileCard();

            loginContainer.classList.add('hidden');
            dashboardView.classList.remove('hidden');

            connectWebSocket();            renderCart(); // Renderiza el carrito (y oculta el bot√≥n si est√° vac√≠o)
            fetchMyList();
        }

        function handleLogout() {
            sessionStorage.removeItem('karaokeUser');
            sessionStorage.removeItem('karaokeTable');
            if (state.websocket) state.websocket.close();
            state.user = null;
            // No recargamos el QR code desde el par√°metro, ya lo tenemos en state.tableQrCode
            dashboardView.classList.add('hidden');
            loginContainer.classList.remove('hidden');
            nickInput.value = '';
            errorMessage.textContent = '';
        }

        function handleTabClick(event) {
            const clickedTab = event.target.closest('.tab-button');
            if (!clickedTab) return;

            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            clickedTab.classList.add('active');
            document.getElementById(clickedTab.dataset.tab).classList.add('active');

            if (clickedTab.dataset.tab === 'tab-my-list') {
                fetchMyList();
            }
            if (clickedTab.dataset.tab === 'tab-my-orders') {
                fetchMyOrders();
            }
            if (clickedTab.dataset.tab === 'tab-my-account') {
                fetchTableAccountStatus();
            }
        }
        function handleTabClick(event) {
            const clickedTab = event.target.closest('.tab-button');
            if (!clickedTab) return;

            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            clickedTab.classList.add('active');
            const activeTabId = clickedTab.dataset.tab;
            document.getElementById(activeTabId).classList.add('active');

            // Cargar contenido seg√∫n la pesta√±a
            switch (activeTabId) {
                case 'tab-my-list':
                    fetchMyList();
                    break;
                case 'tab-catalog':
                    fetchProducts();
                    break;
                case 'tab-my-orders':
                    fetchMyOrders();
                    break;
                case 'tab-my-account':
                    fetchTableAccountStatus();
                    break;
            }
        }

        async function handleSendReaction(event) {
            const emojiSpan = event.target.closest('#reaction-buttons span');
            if (!emojiSpan) return;

            const reaction = emojiSpan.textContent;
            const payload = {
                reaction: reaction,
                sender: state.user ? state.user.nick : "An√≥nimo" // Usar el nick del usuario si est√° logueado
            };
            try {
                await fetch(`${API_BASE_URL}/broadcast/reaction`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            } catch (error) {
                console.error("Error enviando reacci√≥n:", error);
            }
        }

        function updateProfileCard() {
            document.getElementById('user-nick').textContent = state.user.nick;
            document.getElementById('user-points').textContent = state.user.puntos;
            const levelEl = document.getElementById('user-level');
            levelEl.textContent = state.user.nivel.charAt(0).toUpperCase() + state.user.nivel.slice(1);
            levelEl.className = `profile-level level-${state.user.nivel}`;
        }

        function showDashboard() {
            document.getElementById('table-name').textContent = state.tableQrCode;
            updateProfileCard();

            loginContainer.classList.add('hidden');
            dashboardView.classList.remove('hidden');

            connectWebSocket();            renderCart();
            fetchMyList();
        }

        function handleLogout() {
            sessionStorage.removeItem('karaokeUser');
            sessionStorage.removeItem('karaokeTable');
            if (state.websocket) state.websocket.close();
            state.user = null;
            // No recargamos el QR code desde el par√°metro, ya lo tenemos en state.tableQrCode
            dashboardView.classList.add('hidden');
            loginContainer.classList.remove('hidden');
            nickInput.value = '';
            errorMessage.textContent = '';
        }

        async function handleSendReaction(event) {
            const emojiSpan = event.target.closest('#reaction-buttons span');
            if (!emojiSpan) return;

            const reaction = emojiSpan.textContent;
            const payload = {
                reaction: reaction,
                sender: state.user ? state.user.nick : "An√≥nimo" // Usar el nick del usuario si est√° logueado
            };
            try {
                await fetch(`${API_BASE_URL}/broadcast/reaction`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            } catch (error) {
                console.error("Error enviando reacci√≥n:", error);
            }
        }

        function getQueryParam(param) {
            return new URLSearchParams(window.location.search).get(param);
        }

        // --- INICIALIZACI√ìN ---
        window.addEventListener('DOMContentLoaded', () => {
            state.tableQrCode = getQueryParam('table');
            if (!state.tableQrCode) {
                welcomeMessage.textContent = 'Error: No se encontr√≥ el c√≥digo de la mesa.';
                loginForm.classList.add('hidden');
                return;
            }

            const storedUser = sessionStorage.getItem('karaokeUser');
            const storedTable = sessionStorage.getItem('karaokeTable');

            if (storedUser && storedTable === state.tableQrCode) {
                state.user = JSON.parse(storedUser);
                showDashboard();
            }

            // Asignar eventos
            connectButton.addEventListener('click', handleLogin);
            logoutButton.addEventListener('click', handleLogout);
            document.querySelector('.tabs').addEventListener('click', handleTabClick);
            document.getElementById('search-songs-btn').addEventListener('click', (e) => handleSearch(e, false));
            document.getElementById('search-karaoke-btn').addEventListener('click', (e) => handleSearch(e, true));
            document.getElementById('search-results').addEventListener('click', handleAddSong);
            catalogList.addEventListener('click', handleAddToCart);
            document.getElementById('my-orders-list').addEventListener('click', handleCancelOrder);
            document.getElementById('reaction-buttons').addEventListener('click', handleSendReaction);
            document.getElementById('my-song-list').addEventListener('click', handleDeleteSong);
            cancelOrderBtn.addEventListener('click', () => {
                orderModal.style.display = 'none';
            });

            // Eventos del Carrito
            cartConfirmBtnHeader.addEventListener('click', () => {
                cartModal.style.display = 'flex';
                renderCart();
            });
            document.getElementById('cancel-cart-btn').addEventListener('click', () => cartModal.style.display = 'none');
            document.getElementById('confirm-cart-order-btn').addEventListener('click', handlePlaceOrder);
            document.getElementById('cart-items-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('cart-remove-item-btn')) {
                    const productId = parseInt(e.target.dataset.productId, 10);
                    state.cart = state.cart.filter(item => item.producto_id !== productId);
                    renderCart();
                }
            });

        });
    </script>
</body>
</html>